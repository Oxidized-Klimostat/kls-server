version: "3"

services:

  postgres:
    image: timescale/timescaledb:latest-pg15
    ports:
      - 127.0.0.1:5432:5432 # only for development purposes
    environment:
      - POSTGRES_PASSWORD=${PG_PASS:?err}
#    volumes:
#      - ./pgdata:/home/postgres/pgdata/data

  postgres_setup: # https://stackoverflow.com/a/64153124
    image: timescale/timescaledb:latest-pg15
    restart: "no"
    environment:
      - PGPASSWORD=${PG_PASS:?err}
    entrypoint: ["sh", "-c", " \
      sleep 3; psql postgres -U postgres -h postgres -p 5432 --set=auth_pass=\"${AUTH_PASS:?err}\" -f /setup.sql; \
      echo \"postgres setup done\""]
    volumes:
      - ./setup.sql:/setup.sql
    depends_on:
      - postgres

  api:
    image: postgrest/postgrest:latest
    ports:
      - 3000:3000
    environment: # https://postgrest.org/en/stable/references/configuration.html#environment-variables
      - PGRST_DB_URI=postgres://authenticator:${AUTH_PASS:?err}@postgres:5432/postgres
      - PGRST_DB_ANON_ROLE=anon
    depends_on:
      - postgres_setup
